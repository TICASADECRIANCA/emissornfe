<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissor Massa - Focus NFe</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-600">
            <h2 class="text-xl font-bold mb-4">Dados da Venda</h2>
            <form id="nfeForm" class="space-y-3">
                <input type="text" id="cliente" placeholder="RazÃ£o Social / Nome" class="w-full border p-2 rounded" required>
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="doc_cliente" placeholder="CPF ou CNPJ" class="border p-2 rounded" required>
                    <input type="text" id="cep_cliente" placeholder="CEP" class="border p-2 rounded" required>
                </div>
                <hr>
                <label class="text-xs font-bold text-gray-500 uppercase">Valores e Impostos</label>
                <input type="number" step="0.01" id="valorBruto" placeholder="Valor Total R$" class="w-full border p-2 rounded" required>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <span class="text-[10px] text-gray-400">ReduÃ§Ã£o %</span>
                        <input type="number" id="percReducao" value="20" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <span class="text-[10px] text-gray-400">ICMS %</span>
                        <input type="number" id="aliquotaIcms" value="18" class="w-full border p-2 rounded">
                    </div>
                </div>
                
                <div id="resumo" class="bg-gray-50 p-3 rounded text-sm font-mono text-indigo-700">
                    Base: R$ 0.00 | ICMS: R$ 0.00
                </div>

                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700">
                    Salvar na Fila
                </button>
            </form>
        </div>

        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Fila de EmissÃ£o</h2>
                <button id="btnEmitirMassa" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 shadow-lg transition-all">
                    ðŸš€ Emitir em Massa (Focus NFe)
                </button>
            </div>
            
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="border-b text-gray-400 uppercase text-[10px]">
                        <th class="py-2">Cliente</th>
                        <th class="py-2">Base Reduzida</th>
                        <th class="py-2">ICMS</th>
                        <th class="py-2">Status</th>
                    </tr>
                </thead>
                <tbody id="tabelaVendas" class="divide-y"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // CONFIGURAÃ‡ÃƒO DO FIREBASE (Mantenha as suas chaves aqui)
        const firebaseConfig = {
  apiKey: "AIzaSyCPXMQfxQ_q8B3MgKK4KK3qDtVD3GDYnhg",
  authDomain: "emissor-2a55a.firebaseapp.com",
  projectId: "emissor-2a55a",
  storageBucket: "emissor-2a55a.firebasestorage.app",
  messagingSenderId: "289980588435",
  appId: "1:289980588435:web:4588d7ee43bc1ef9ff4866"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tokenFocus = "fD3xZpJer34QFZn5joKWqr1Tz09b99Sr";

        // LÃ³gica de CÃ¡lculo
        function calcular() {
            const v = parseFloat(document.getElementById('valorBruto').value) || 0;
            const r = parseFloat(document.getElementById('percReducao').value) || 0;
            const i = parseFloat(document.getElementById('aliquotaIcms').value) || 0;
            const base = v * ((100 - r) / 100);
            const icms = base * (i / 100);
            document.getElementById('resumo').innerText = `Base: R$ ${base.toFixed(2)} | ICMS: R$ ${icms.toFixed(2)}`;
            return { base, icms };
        }
        ['valorBruto', 'percReducao', 'aliquotaIcms'].forEach(id => document.getElementById(id).addEventListener('input', calcular));

        // Salvar no Firebase
        document.getElementById('nfeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const c = calcular();
            await addDoc(collection(db, "vendas_nfe"), {
                cliente: document.getElementById('cliente').value,
                documento: document.getElementById('doc_cliente').value,
                cep: document.getElementById('cep_cliente').value,
                valorBruto: parseFloat(document.getElementById('valorBruto').value),
                baseCalculo: c.base,
                icms: c.icms,
                status: "pendente"
            });
            document.getElementById('nfeForm').reset();
        });

        // Listagem
        onSnapshot(query(collection(db, "vendas_nfe"), where("status", "==", "pendente")), (snap) => {
            const t = document.getElementById('tabelaVendas'); t.innerHTML = "";
            snap.forEach(d => {
                const item = d.data();
                t.innerHTML += `<tr class="border-b">
                    <td class="py-3"><b>${item.cliente}</b><br><span class="text-xs text-gray-400">${item.documento}</span></td>
                    <td class="py-3">R$ ${item.baseCalculo.toFixed(2)}</td>
                    <td class="py-3">R$ ${item.icms.toFixed(2)}</td>
                    <td class="py-3"><span class="bg-yellow-100 text-yellow-600 p-1 rounded text-[10px]">PENDENTE</span></td>
                </tr>`;
            });
        });

        // EMISSÃƒO EM MASSA REAL (FOCUS NFE)
        document.getElementById('btnEmitirMassa').addEventListener('click', async () => {
            const snap = await getDocs(query(collection(db, "vendas_nfe"), where("status", "==", "pendente")));
            if(snap.empty) return alert("Nada para emitir!");

            for(const d of snap.docs) {
                const data = d.data();
                const nfeBody = {
                    "natureza_operacao": "Venda",
                    "nome_destinatario": data.cliente,
                    "cpf_destinatario": data.documento,
                    "cep_destinatario": data.cep,
                    "items": [{
                        "numero_item": 1, "codigo_produto": "001", "descricao": "Venda de Produto", "ncm": "9403.60.00", "cfop": "5102",
                        "valor_unitario_comercial": data.valorBruto, "valor_bruto": data.valorBruto,
                        "icms_situacao_tributaria": "20", "icms_origem": "0", "icms_base_calculo": data.baseCalculo,
                        "icms_aliquota": 18, "icms_valor": data.icms, "icms_percentual_reducao": 20
                    }]
                };

                const res = await fetch("https://homologacao.focusnfe.com.br/v2/nfe", {
                    method: 'POST',
                    headers: { 'Authorization': 'Basic ' + btoa(tokenFocus + ":"), 'Content-Type': 'application/json' },
                    body: JSON.stringify(nfeBody)
                });

                if(res.ok) {
                    await updateDoc(doc(db, "vendas_nfe", d.id), { status: "emitido" });
                }
            }
            alert("Processo concluÃ­do!");
        });
    </script>
</body>
</html>
